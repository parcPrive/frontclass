<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <input type="text" placeholder="ì§€ì—­ê²€ìƒ‰" class="ec-car-station" />
    <button class="btn-search">ì°¾ê¸°</button>
    <div id="map" style="width: 100%; height: 800px"></div>
    <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=3fc68b0624b62813d8ebe3eb6b8f4571&libraries=services,clusterer"
    ></script>
    <style>
      .wrap {
        position: absolute;
        left: 0;
        bottom: 40px;
        width: 288px;
        height: 132px;
        margin-left: -144px;
        text-align: left;
        overflow: hidden;
        font-size: 12px;
        font-family: "Malgun Gothic", dotum, "ë‹ì›€", sans-serif;
        line-height: 1.5;
      }
      .wrap * {
        padding: 0;
        margin: 0;
      }
      .wrap .info {
        width: 286px;
        height: 120px;
        border-radius: 5px;
        border-bottom: 2px solid #ccc;
        border-right: 1px solid #ccc;
        overflow: hidden;
        background: #fff;
      }
      .wrap .info:nth-child(1) {
        border: 0;
        box-shadow: 0px 1px 2px #888;
      }
      .info .title {
        padding: 5px 0 0 10px;
        height: 30px;
        background: #eee;
        border-bottom: 1px solid #ddd;
        font-size: 18px;
        font-weight: bold;
      }
      .info .close {
        position: absolute;
        top: 10px;
        right: 10px;
        color: #888;
        width: 17px;
        height: 17px;
        background: url("https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/overlay_close.png");
      }
      .info .close:hover {
        cursor: pointer;
      }
      .info .body {
        position: relative;
        overflow: hidden;
      }
      .info .desc {
        position: relative;
        margin: 13px 0 0 90px;
        height: 75px;
      }
      .desc .ellipsis {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .desc .jibun {
        font-size: 11px;
        color: #888;
        margin-top: -2px;
      }
      .info .img {
        position: absolute;
        top: 6px;
        left: 5px;
        width: 73px;
        height: 71px;
        border: 1px solid #ddd;
        color: #888;
        overflow: hidden;
      }
      .info:after {
        content: "";
        position: absolute;
        margin-left: -12px;
        left: 50%;
        bottom: 0;
        width: 22px;
        height: 12px;
        background: url("https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/vertex_white.png");
      }
      .info .link {
        color: #5085bb;
      }
    </style>
    <script>
      // const close = document.querySelector(".close");
      document.body.addEventListener("click", (e) => {
        // console.log("closeë¥¼ í´ë¦­í–ˆìŠµë‹ˆë‹¤.");
        // console.log(e.target);
        console.log(e.target.classList.contains("close"));
        if (e.target.classList.contains("close")) {
          console.log("ì—¬ê¸°ë“¤ì˜´?");
          overlay.setMap(null);
        }
      });

      //-------ì²˜ìŒ ì‹œì‘ ìœ„ì¹˜---------
      const container = document.querySelector("#map");
      const options = {
        center: new kakao.maps.LatLng(37.4652145691216, 127.044669250318),
        level: 14,
      };
      const map = new kakao.maps.Map(container, options);
      //-------ì²˜ìŒ ì‹œì‘ ìœ„ì¹˜---------
      const ecCarStation = document.querySelector(".ec-car-station");
      const btnSearch = document.querySelector(".btn-search");
      console.log(ecCarStation.value);
      const click = true;
      btnSearch.addEventListener("click", () => {
        console.log(ecCarStationSearch(ecCarStation.value));
        if (click) {
          click = false;
          ecCarStationSearch(ecCarStation.value);
          return true;
        } else {
          return false;
        }
      });
      ecCarStation.addEventListener("keydown", (el) => {
        console.log(el.keyCode);
        if (el.isComposing) return;
        else {
          if (el.key === "Enter") {
            ecCarStationSearch(ecCarStation.value);
          }
        }

        // console.log("í´ëŸ¬ìŠ¤í„°ì—¬ê¸°ë‹¹");
      });
      // const content = `<div class="wrap">
      //                 <div class="info">
      //                     <div class="title">
      //                         ì¹´ì¹´ì˜¤ ìŠ¤í˜ì´ìŠ¤ë‹·ì›
      //                         <div class="close" title="ë‹«ê¸°"></div>
      //                     </div>
      //                     <div class="body">
      //                         <div class="desc">
      //                             <div class="ellipsis">ì œì£¼íŠ¹ë³„ìì¹˜ë„ ì œì£¼ì‹œ ì²¨ë‹¨ë¡œ 242</div>
      //                             <div class="jibun ellipsis">(ìš°) 63309 (ì§€ë²ˆ) ì˜í‰ë™ 2181</div>
      //                             <div><a href="https://www.kakaocorp.com/main" target="_blank" class="link">í™ˆí˜ì´ì§€</a></div>
      //                         </div>
      //                     </div>
      //                 </div>
      //             </div>`;

      // ë§ˆì»¤ ìœ„ì— ì»¤ìŠ¤í…€ì˜¤ë²„ë ˆì´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤
      // ë§ˆì»¤ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ë¥¼ í‘œì‹œí•˜ê¸°ìœ„í•´ CSSë¥¼ ì´ìš©í•´ ìœ„ì¹˜ë¥¼ ì„¤ì •í–ˆìŠµë‹ˆë‹¤
      const overlay = new kakao.maps.CustomOverlay({
        // content: content,
        map: map,
        position: new kakao.maps.LatLng(),
        // zIndex: 3,
      });
      console.log("ğŸ°ğŸ°ğŸ°");
      const clusterer = new kakao.maps.MarkerClusterer({
        map: map, // ë§ˆì»¤ë“¤ì„ í´ëŸ¬ìŠ¤í„°ë¡œ ê´€ë¦¬í•˜ê³  í‘œì‹œí•  ì§€ë„ ê°ì²´
        averageCenter: true, // í´ëŸ¬ìŠ¤í„°ì— í¬í•¨ëœ ë§ˆì»¤ë“¤ì˜ í‰ê·  ìœ„ì¹˜ë¥¼ í´ëŸ¬ìŠ¤í„° ë§ˆì»¤ ìœ„ì¹˜ë¡œ ì„¤ì •
        minLevel: 10, // í´ëŸ¬ìŠ¤í„° í•  ìµœì†Œ ì§€ë„ ë ˆë²¨
      });
      console.log("ğŸ°ğŸ°ğŸ°");

      // ë§ˆì»¤ë¥¼ í´ë¦­í–ˆì„ ë•Œ ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤
      // kakao.maps.event.addListener(marker, click, function () {
      //   overlay.setMap(map);
      // });
      function ecCarStationSearch(ecCarStation) {
        fetch(
          `https://api.odcloud.kr/api/EvInfoServiceV2/v1/getEvSearchList?page=1&perPage=300&cond[addr::LIKE]=${ecCarStation}&serviceKey=qSSreNvhgqXTKW%2FALIPK%2FDyuZSuKCqXI1AjmzCL7wNDMC3YMXaxGQcpxLaO%2BuC4Td2IL2ywb2hxhl%2BdRREyCDQ%3D%3D`
        )
          .then((res) => {
            clusterer.clear();
            console.log("res");

            return res.json();
          })
          .then((result) => {
            if (result.data.length === 0) {
              alert("ë‹¤ì‹œì…ë ¥í•´ì£¼ì„¸ì—¬.");
            }
            const stationList = [...result.data];
            const markers = [];

            console.log(stationList);

            overlay.setContent("");
            // console.log(stationList, markers);
            stationList.forEach((el) => {
              // lat.push(el.lat);
              // longi.push(el.longi);
              // ë§ˆì»¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
              const marker = new kakao.maps.Marker({
                map: map, // ë§ˆì»¤ë¥¼ í‘œì‹œí•  ì§€ë„
                position: new kakao.maps.LatLng(el.lat, el.longi), // ë§ˆì»¤ë¥¼ í‘œì‹œí•  ìœ„ì¹˜
                title: el.csNm, // ë§ˆì»¤ì˜ íƒ€ì´í‹€, ë§ˆì»¤ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ íƒ€ì´í‹€ì´ í‘œì‹œë©ë‹ˆë‹¤
                // image: markerImage, // ë§ˆì»¤ ì´ë¯¸ì§€
              });
              markers.push(marker);

              // ì—¬ê¸°ì— ë§ˆì»¤ê°€ ì—¬ëŸ¬ê°œ ìƒì„±ë˜ë‹ˆ ì´ë²¤íŠ¸ë¥¼ ì—¬ê¸°ë‹¤ê°€ ì‘ì„±í•œë‹¤.
              kakao.maps.event.addListener(marker, "click", function () {
                // alert("marker click!");
                overlay.setMap(map);
                overlay.setPosition(marker.getPosition());
                overlay.setContent(`<div class="wrap">
                        <div class="info">
                            <div class="title">
                                ${el.csNm}
                                <div class="close" title="ë‹«ê¸°"></div>
                            </div>
                            <div class="body">
                                <div class="desc">
                                    <div class="ellipsis">${el.addr}</div>
                                    <div class="ellipsis">ì¶©ì „íƒ€ì…:${el.cpNm}</div>
                                </div>
                            </div>
                        </div>
                    </div>`);
              });
            });
            clusterer.addMarkers(markers);
          })
          .catch((e) => {
            console.log("ìº£");
            console.log(e);
            al;
          });
      }
    </script>
  </body>
</html>
